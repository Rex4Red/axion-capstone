<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #05080f; color: white; font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .interview-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        
        .question-card {
            background: #EEE9DF; color: #1B2632; padding: 30px; border-radius: 20px;
            max-width: 800px; width: 100%; margin-bottom: 20px; position: relative;
        }
        h2.question-text { font-weight: 800; font-size: 1.5rem; }

        /* Video Area */
        .video-wrapper {
            width: 100%; max-width: 640px; height: 360px; background: black;
            border-radius: 16px; overflow: hidden; position: relative;
            border: 2px solid #333; margin-bottom: 20px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* Mirror effect */
        
        /* Upload Tab Styling */
        .nav-pills .nav-link { color: #888; border-radius: 50px; padding: 8px 20px; cursor: pointer; }
        .nav-pills .nav-link.active { background-color: #A35139; color: white; }

        /* Controls */
        .record-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            background: #ef4444; color: white; font-size: 1.5rem;
            transition: 0.3s; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }
        .record-btn.recording { animation: pulse 1.5s infinite; background: white; color: #ef4444; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0, 0); } }

        /* Cheat Warning */
        #cheatAlert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,0,0,0.8); z-index: 9999; display: none;
            align-items: center; justify-content: center; flex-direction: column;
        }
        
        /* Animasi Selesai */
        .animate-bounce { animation: bounce 1s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    </style>
</head>
<body>
    
    <div id="cheatAlert">
        <i class="fa-solid fa-triangle-exclamation fa-5x text-white mb-3"></i>
        <h1 class="fw-bold text-white">DILARANG PINDAH TAB!</h1>
        <p class="text-white">Sistem mendeteksi Anda meninggalkan layar ujian.</p>
        <button class="btn btn-light rounded-pill fw-bold" onclick="closeCheatAlert()">Saya Mengerti</button>
    </div>

    <div id="completionScreen" class="interview-container" style="display: none;">
        <div class="question-card text-center p-5" style="max-width: 600px;">
            <div class="mb-4">
                <i class="fa-solid fa-circle-check fa-6x text-success animate-bounce"></i>
            </div>
            
            <h1 class="fw-bold mb-3" style="color: #1B2632;">Luar Biasa!</h1>
            
            <p class="text-muted mb-4 fs-5">
                Sesi interview Anda telah selesai. <br>
                Jawaban video Anda berhasil tersimpan dan sedang diproses oleh AI.
            </p>
    
            <div class="d-grid gap-2 col-8 mx-auto">
                <a href="/" class="btn btn-dark rounded-pill py-3 fw-bold transition-all">
                    <i class="fa-solid fa-house me-2"></i> Kembali ke Beranda
                </a>
            </div>
            
            <div class="mt-4 small text-muted">
                <i class="fa-solid fa-envelope me-1"></i> Hasil akan dikirimkan via email.
            </div>
        </div>
    </div>

    <div class="interview-container" id="mainArea">
        
        <div class="question-card">
            <span class="badge bg-dark mb-2">Question <span id="qIndex">1</span> / <span id="qTotal"></span></span>
            <h2 class="question-text" id="qText">Loading...</h2>
        </div>

        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
            <li class="nav-item">
                <button class="nav-link active" onclick="switchMode('webcam')">Live Webcam</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchMode('upload')">Upload Video</button>
            </li>
        </ul>

        <div id="webcamMode">
            <div class="video-wrapper">
                <video id="liveVideo" autoplay muted playsinline></video>
            </div>
            <div id="webcamControls">
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <i class="fa-solid fa-video"></i>
                </button>
                <div class="mt-2 text-muted small" id="statusText">Tap to record</div>
            </div>
        </div>

        <div id="uploadMode" style="display: none;">
            <div class="card p-4 bg-dark border-secondary text-white" style="max-width: 500px;">
                <label class="form-label">Pilih file video jawaban Anda (MP4/WebM)</label>
                <input type="file" class="form-control mb-3" id="videoInput" accept="video/*">
                
                <button id="btnUpload" class="btn btn-primary w-100 fw-bold" onclick="uploadManualFile()">
                    <i class="fa-solid fa-cloud-arrow-up me-2"></i> Upload Video
                </button>
            </div>
        </div>

        <button class="btn btn-success rounded-pill px-4 py-2 mt-4" id="nextBtn" style="display:none;" onclick="nextQuestion()">
            Lanjut Soal Berikutnya <i class="fa-solid fa-arrow-right ms-2"></i>
        </button>

    </div>

    <script>
        const questions = [
            {% for q in questions %} { id: {{ q.id }}, text: "{{ q.question_text }}" }, {% endfor %}
        ];
        const candidateId = {{ candidate.id }};
    </script>

    <script>
        let currentIdx = 0;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let cheatCount = 0; 
        let stream = null;

        document.getElementById('qTotal').innerText = questions.length;
        loadQuestion(currentIdx);
        initCamera();

        // 1. ANTI-CHEAT
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                cheatCount++;
                document.getElementById('cheatAlert').style.display = 'flex';
            }
        });

        function closeCheatAlert() {
            document.getElementById('cheatAlert').style.display = 'none';
        }

        // 2. WEBCAM
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('liveVideo').srcObject = stream;
            } catch (err) {
                console.log("Webcam error/blocked");
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) recordedChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    sendData(blob);
                };

                mediaRecorder.start();
                isRecording = true;
                updateRecUI(true);
            } else {
                mediaRecorder.stop();
                isRecording = false;
                updateRecUI(false);
            }
        }

        // 3. UPLOAD MANUAL (Loading Animation)
        function uploadManualFile() {
            const fileInput = document.getElementById('videoInput');
            const btn = document.getElementById('btnUpload'); 

            if (fileInput.files.length === 0) {
                alert("Pilih file video jawaban Anda terlebih dahulu!");
                return;
            }

            // Animasi Loading
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin me-2"></i> Mengupload & Menganalisis...';
            btn.className = "btn btn-warning w-100 fw-bold"; 
            btn.disabled = true; 

            sendData(fileInput.files[0]);
        }

        // 4. KIRIM DATA KE SERVER
        function sendData(fileBlob) {
            document.getElementById('statusText').innerText = "Uploading Video & AI Analysis... (Sabar ya)";
            document.getElementById('recordBtn').style.display = 'none';

            const formData = new FormData();
            formData.append('video', fileBlob);
            formData.append('candidate_id', candidateId);
            formData.append('question_id', questions[currentIdx].id);
            formData.append('cheat_count', cheatCount);

            fetch('/submit-answer', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    document.getElementById('nextBtn').style.display = 'inline-block';
                    document.getElementById('statusText').innerText = "Tersimpan!";
                    
                    // Reset Tombol Upload jadi Sukses
                    const btn = document.getElementById('btnUpload');
                    if(btn) {
                        btn.innerHTML = '<i class="fa-solid fa-check me-2"></i> Berhasil Terupload';
                        btn.className = "btn btn-success w-100 fw-bold";
                    }
                } else {
                    alert("Gagal: " + data.msg);
                    location.reload();
                }
            })
            .catch(err => {
                console.error(err);
                alert("Terjadi kesalahan koneksi.");
                const btn = document.getElementById('btnUpload');
                if(btn) {
                    btn.innerHTML = 'Upload Video';
                    btn.className = "btn btn-primary w-100";
                    btn.disabled = false;
                }
            });
        }

        // 5. NAVIGASI SOAL & HALAMAN SELESAI
        function loadQuestion(idx) {
            document.getElementById('qIndex').innerText = idx + 1;
            document.getElementById('qText').innerText = questions[idx].text;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('recordBtn').style.display = 'block';
            document.getElementById('statusText').innerText = "Tap camera to record";
            
            // Reset UI Upload
            document.getElementById('videoInput').value = "";
            const btn = document.getElementById('btnUpload');
            if(btn) {
                btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up me-2"></i> Upload Video';
                btn.className = "btn btn-primary w-100 fw-bold";
                btn.disabled = false;
            }
        }

        function nextQuestion() {
            currentIdx++;
            if (currentIdx < questions.length) {
                loadQuestion(currentIdx);
            } else {
                // --- TAMPILKAN LAYAR SELESAI ---
                document.getElementById('mainArea').style.display = 'none';
                document.getElementById('completionScreen').style.display = 'flex';
                
                // Matikan kamera
                if(stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
        }

        function switchMode(mode) {
            if(mode === 'webcam') {
                document.getElementById('webcamMode').style.display = 'block';
                document.getElementById('uploadMode').style.display = 'none';
                document.querySelectorAll('.nav-link')[0].classList.add('active');
                document.querySelectorAll('.nav-link')[1].classList.remove('active');
            } else {
                document.getElementById('webcamMode').style.display = 'none';
                document.getElementById('uploadMode').style.display = 'block';
                document.querySelectorAll('.nav-link')[0].classList.remove('active');
                document.querySelectorAll('.nav-link')[1].classList.add('active');
            }
            document.getElementById('statusText').innerText = "";
        }

        function updateRecUI(recording) {
            const btn = document.getElementById('recordBtn');
            if (recording) {
                btn.classList.add('recording');
                btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                document.getElementById('statusText').innerText = "Recording...";
            } else {
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="fa-solid fa-video"></i>';
                document.getElementById('statusText').innerText = "Processing...";
            }
        }
    </script>
</body>
</html>