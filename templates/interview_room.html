<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #05080f; color: white; font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .interview-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        
        .question-card {
            background: #EEE9DF; color: #1B2632; padding: 30px; border-radius: 20px;
            max-width: 800px; width: 100%; margin-bottom: 20px; position: relative;
        }
        h2.question-text { font-weight: 800; font-size: 1.5rem; }

        /* Video Area */
        .video-wrapper {
            width: 100%; max-width: 640px; height: 360px; background: black;
            border-radius: 16px; overflow: hidden; position: relative;
            border: 2px solid #333; margin-bottom: 20px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* Mirror effect */
        
        /* Upload Tab Styling */
        .nav-pills .nav-link { color: #888; border-radius: 50px; padding: 8px 20px; }
        .nav-pills .nav-link.active { background-color: #A35139; color: white; }

        /* Controls */
        .record-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            background: #ef4444; color: white; font-size: 1.5rem;
            transition: 0.3s; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }
        .record-btn.recording { animation: pulse 1.5s infinite; background: white; color: #ef4444; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0, 0); } }

        /* Cheat Warning */
        #cheatAlert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,0,0,0.8); z-index: 9999; display: none;
            align-items: center; justify-content: center; flex-direction: column;
        }
    </style>
</head>
<body>
    
    <div id="cheatAlert">
        <i class="fa-solid fa-triangle-exclamation fa-5x text-white mb-3"></i>
        <h1 class="fw-bold text-white">DILARANG PINDAH TAB!</h1>
        <p class="text-white">Sistem mendeteksi Anda meninggalkan layar ujian.</p>
        <button class="btn btn-light rounded-pill fw-bold" onclick="closeCheatAlert()">Saya Mengerti</button>
    </div>

    <div class="interview-container" id="mainArea">
        
        <div class="question-card">
            <span class="badge bg-dark mb-2">Question <span id="qIndex">1</span> / <span id="qTotal"></span></span>
            <h2 class="question-text" id="qText">Loading...</h2>
        </div>

        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" onclick="switchMode('webcam')">Live Webcam</button></li>
            <li class="nav-item"><button class="nav-link" onclick="switchMode('upload')">Upload Video</button></li>
        </ul>

        <div id="webcamMode">
            <div class="video-wrapper">
                <video id="liveVideo" autoplay muted playsinline></video>
            </div>
            <div id="webcamControls">
                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                    <i class="fa-solid fa-video"></i>
                </button>
                <div class="mt-2 text-muted small" id="statusText">Tap to record</div>
            </div>
        </div>

        <div id="uploadMode" style="display: none;">
            <div class="card p-4 bg-dark border-secondary text-white" style="max-width: 500px;">
                <label class="form-label">Pilih file video jawaban Anda (MP4/WebM)</label>
                <input type="file" class="form-control mb-3" id="videoInput" accept="video/*">
                <button class="btn btn-primary w-100" onclick="uploadManualFile()">Upload Video</button>
            </div>
        </div>

        <button class="btn btn-success rounded-pill px-4 py-2 mt-4" id="nextBtn" style="display:none;" onclick="nextQuestion()">
            Lanjut Soal Berikutnya <i class="fa-solid fa-arrow-right ms-2"></i>
        </button>

    </div>

    <script>
        const questions = [
            {% for q in questions %} { id: {{ q.id }}, text: "{{ q.question_text }}" }, {% endfor %}
        ];
        const candidateId = {{ candidate.id }};
    </script>

    <script>
        let currentIdx = 0;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let cheatCount = 0; // Menghitung pelanggaran
        let stream = null;

        // Init
        document.getElementById('qTotal').innerText = questions.length;
        loadQuestion(currentIdx);
        initCamera();

        // --- 1. LOGIC ANTI-CHEAT (TAB SWITCH DETECTION) ---
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                cheatCount++;
                // Tampilkan Layar Merah Peringatan
                document.getElementById('cheatAlert').style.display = 'flex';
                console.log("Curang terdeteksi! Total: " + cheatCount);
            }
        });

        function closeCheatAlert() {
            document.getElementById('cheatAlert').style.display = 'none';
        }

        // --- 2. LOGIC WEBCAM & RECORDING ---
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('liveVideo').srcObject = stream;
            } catch (err) {
                alert("Gagal akses kamera! Pastikan izin diberikan.");
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                // Start
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) recordedChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    sendData(blob);
                };

                mediaRecorder.start();
                isRecording = true;
                updateRecUI(true);
            } else {
                // Stop
                mediaRecorder.stop();
                isRecording = false;
                updateRecUI(false);
            }
        }

        // --- 3. LOGIC UPLOAD MANUAL ---
        function uploadManualFile() {
            const fileInput = document.getElementById('videoInput');
            if (fileInput.files.length === 0) {
                alert("Pilih file video dulu!");
                return;
            }
            sendData(fileInput.files[0]);
        }

        // --- CORE: SEND DATA TO SERVER ---
        function sendData(fileBlob) {
            document.getElementById('statusText').innerText = "Uploading Video & AI Analysis... (Sabar ya)";
            document.getElementById('recordBtn').style.display = 'none'; // Cegah double klik

            const formData = new FormData();
            formData.append('video', fileBlob); // Nama field jadi 'video'
            formData.append('candidate_id', candidateId);
            formData.append('question_id', questions[currentIdx].id);
            formData.append('cheat_count', cheatCount); // Kirim data kecurangan

            fetch('/submit-answer', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    document.getElementById('nextBtn').style.display = 'inline-block';
                    document.getElementById('statusText').innerText = "Tersimpan!";
                    // Reset cheat count untuk soal berikutnya (opsional)
                    // cheatCount = 0; 
                } else {
                    alert("Gagal: " + data.msg);
                    location.reload();
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error upload.");
                location.reload();
            });
        }

        // --- UTILS ---
        function loadQuestion(idx) {
            document.getElementById('qIndex').innerText = idx + 1;
            document.getElementById('qText').innerText = questions[idx].text;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('recordBtn').style.display = 'block';
            document.getElementById('statusText').innerText = "Tap camera to record";
        }

        function nextQuestion() {
            currentIdx++;
            if (currentIdx < questions.length) {
                loadQuestion(currentIdx);
            } else {
                document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:100px;'>Interview Selesai! Terima kasih.</h1>";
            }
        }

        function switchMode(mode) {
            if(mode === 'webcam') {
                document.getElementById('webcamMode').style.display = 'block';
                document.getElementById('uploadMode').style.display = 'none';
                document.querySelectorAll('.nav-link')[0].classList.add('active');
                document.querySelectorAll('.nav-link')[1].classList.remove('active');
            } else {
                document.getElementById('webcamMode').style.display = 'none';
                document.getElementById('uploadMode').style.display = 'block';
                document.querySelectorAll('.nav-link')[0].classList.remove('active');
                document.querySelectorAll('.nav-link')[1].classList.add('active');
            }
            
            // UI Reset
            document.getElementById('statusText').innerText = "";
        }

        function updateRecUI(recording) {
            const btn = document.getElementById('recordBtn');
            if (recording) {
                btn.classList.add('recording');
                btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                document.getElementById('statusText').innerText = "Recording...";
            } else {
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="fa-solid fa-video"></i>';
                document.getElementById('statusText').innerText = "Processing...";
            }
        }
    </script>
</body>
</html>